<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title></title>
  <style>
    .message {
      font-size: 24px;
      text-align: center;
      margin-top: 100px;
    }

    .success {
      color: green;
    }

    .failure {
      color: red;
    }
  </style>
</head>

<body>
  <div id="root">
    <div class="message" id="message">Wait Step 2 Login</div>
  </div>
  <script>
    (function() {
      var array = window.location.search.split('&');
      var username = '';
      var password = '';
      var oauth_verifier = '';
      var scheme = '';
      array.forEach(function(item) {
        if (item.indexOf('username=') >= 0) {
          username = item.split('=')[1];
        }
        if (item.indexOf('password=') >= 0) {
          password = item.split('=')[1];
        }
        if (item.indexOf('oauth_verifier=') >= 0) {
          oauth_verifier = item.split('=')[1];
        }
        if (item.indexOf('scheme=') >= 0) {
          scheme = item.split('=')[1];
        }
      });

      //创建xhr对象
      var xhr;
      if (window.XMLHttpRequest) {
        xhr = new XMLHttpRequest();
      } else {
        xhr = new ActiveXObject('Microsoft.XMLHTTP');
      }

      var url = 'https://webapi-os.account.hoyoverse.com';

      if (window.location.host.indexOf('mihoyo.com') > -1) {
        url = url.replace('hoyoverse.com', 'mihoyo.com');
      }

      // 登录回调
      if (username && password) {
        var accessToken = btoa(JSON.stringify({
          account: username,
          password: password,
          is_crypto: false
        }));
        //异步接受响应
        xhr.onreadystatechange = function() {
          if (xhr.readyState == 4) {
            if (xhr.status == 200) {
              //实际操作
              var res = JSON.parse(xhr.responseText);
              if (res.data.status == 1) {

                if (scheme) {
                  showMessage('success', 'Login successful 1');
                  window.location.href = scheme + '://twitterLoginCallback?accessToken=' + res.data.access_token;
                } else {
                  let d = 'uniwebview://sdkThirdLogin?accessToken='+res.data.access_token;
                  showMessage('success', `Login successful<br><a href="${d}">if not work</a>`);
                  window.location.href = d;
                }

              } else {
                showMessage('failure', 'Login failed. Please try again.');
              }
            } else {
              showMessage('failure', 'An error occurred. Please try again later.');
            }
          }
        };
        //发送请求
        xhr.open('get', url + '/Api/twitter_access?access_token=' + accessToken);
        xhr.withCredentials = true;
        xhr.send();
        return;
      }

      //异步接受响应
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
          if (xhr.status == 200) {
            //实际操作
            var res = JSON.parse(xhr.responseText);
            if (res.data.status == 1) {
              showMessage('success', 'Redirecting to login page...');
              window.location.href = res.data.auth_url;
            } else {
              showMessage('failure', 'An error occurred. Please try again later.');
            }
          } else {
            showMessage('failure', 'An error occurred. Please try again later.');
          }
        }
      };
      //发送请求
      xhr.open('get', url + '/Api/twitter_login?consumer_key=' + consumer_key + '&callback=' + encodeURIComponent(window.location.href));
      xhr.withCredentials = true;
      xhr.send();

      function showMessage(type, message) {
        var messageElement = document.getElementById('message');
        messageElement.innerHTML = message;
        messageElement.classList.remove('success', 'failure');
        messageElement.classList.add(type);
      }
    })()
  </script>
</body>

</html>